<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GoodWave Staking â€” Devnet Live Demo</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --bg:#0b1220; --panel:#0f1830; --text:#e7eeff; --muted:#8aa1c7; --accent:#3b82f6; }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:1000px;margin:42px auto;padding:0 20px;}
  h1{font-weight:800;letter-spacing:.3px;margin:0 0 12px;}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:14px 0 18px;}
  .card{background:var(--panel);border-radius:14px;padding:16px 18px;box-shadow:0 2px 18px rgba(0,0,0,.25)}
  .k{font-size:13px;color:var(--muted);margin-bottom:6px}
  .v{font-size:22px;font-weight:750}
  .live{margin:8px 0 18px;font-size:13px;color:#86efac}
  .legend{display:flex;gap:14px;font-size:13px;color:var(--muted);margin:10px 0 6px}
  .dot{width:10px;height:10px;border-radius:50%}
  .row{display:flex;align-items:center;gap:10px}
  canvas{background:#0a1327;border-radius:14px}
  a{color:#9cc2ff;text-decoration:none}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸŒŠ GoodWave Staking â€” Devnet Live Demo</h1>

    <div class="kpis">
      <div class="card"><div class="k">Total Staked</div><div class="v" id="kpi-staked">â€” GWAVE</div></div>
      <div class="card"><div class="k">Total Earned</div><div class="v" id="kpi-earned">â€” GWAVE</div></div>
      <div class="card"><div class="k">Total Fees Earned</div><div class="v" id="kpi-fees">â€” GWAVE</div></div>
    </div>

    <div class="live" id="kpi-live">LIVE â€¢ waiting for dataâ€¦</div>

    <div class="legend">
      <div class="row"><div class="dot" style="background:#60a5fa"></div><span>Staked</span></div>
      <div class="row"><div class="dot" style="background:#34d399"></div><span>Earned</span></div>
      <div class="row"><div class="dot" style="background:#f59e0b"></div><span>Fees (cumulative)</span></div>
    </div>

    <div class="card"><canvas id="gw-chart" height="120"></canvas></div>

    <p class="muted" style="margin-top:14px">
      Updates every ~60s from <code>docs/data/index.json</code> and <code>docs/data/pool.json</code>.
      Source: <a href="./">repo</a>
    </p>
  </div>

<script>
const fmt = n => Number(n ?? 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:6});
const $ = sel => document.querySelector(sel);
const cacheBust = () => `?ts=${Date.now()}`;
async function jget(path){ const r = await fetch(`data/${path}${cacheBust()}`, {cache:'no-store'}); if(!r.ok) throw new Error(path+': '+r.status); return r.json(); }

let chart;
function ensureChart(labels, staked, earned, fees){
  const ctx = document.getElementById('gw-chart').getContext('2d');
  if (chart) { chart.data.labels = labels; chart.data.datasets[0].data = staked; chart.data.datasets[1].data = earned; chart.data.datasets[2].data = fees; chart.update(); return; }
  chart = new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[
      { label:'Staked', data:staked, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,.2)', tension:.25, fill:false },
      { label:'Earned', data:earned, borderColor:'#34d399', backgroundColor:'rgba(52,211,153,.2)', tension:.25, fill:false },
      { label:'Fees',   data:fees,   borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,.2)', tension:.25, fill:false },
    ]},
    options:{
      responsive:true,
      animation:false,
      plugins:{ legend:{display:false}},
      scales:{
        x:{ ticks:{ color:'#8aa1c7' }, grid:{ color:'rgba(255,255,255,.06)'} },
        y:{ ticks:{ color:'#8aa1c7' }, grid:{ color:'rgba(255,255,255,.06)'} }
      }
    }
  });
}

function age(tsIso){
  const now = Date.now(), then = Date.parse(tsIso||Date.now());
  const s = Math.max(0,Math.round((now-then)/1000));
  return s + 's ago';
}

async function refresh(){
  try{
    // pool.json has the freshest KPIs
    const pool = await jget('pool.json');
    $('#kpi-staked').textContent = `${fmt(pool.total_staked)} GWAVE`;
    $('#kpi-earned').textContent = `${fmt(pool.total_earned)} GWAVE`;
    $('#kpi-fees').textContent   = `${fmt(pool.fees_total)} GWAVE`;
    $('#kpi-live').textContent   = `LIVE â€¢ updated ${age(pool.ts)}`;

    // index.json for historical lines
    const idx = await jget('index.json');
    const points = Array.isArray(idx.points) ? idx.points : [];
    const labels = points.map((p,i)=> p.ts || i+1);
    const staked = points.map(p => Number(p.total_staked||0));
    const earned = points.map(p => Number(p.total_earned||0));
    const fees   = points.map((_,i)=> Number(idx.fees_total||0)); // draw as flat/cumulative
    ensureChart(labels, staked, earned, fees);
  }catch(e){
    $('#kpi-live').textContent = 'Waiting for dataâ€¦ (auto-retrying)';
    console.error(e);
  }
}
refresh();
setInterval(refresh, 60000);
</script>
<!-- GWAVE LIVE PULSE MODULE (drop-in, idempotent) -->
<style>
  .gwave-livebar {
    display:flex; align-items:center; gap:.75rem;
    padding:.5rem .75rem; margin:.75rem 0 1rem 0;
    border-radius:12px; background:#0b1220; color:#d7e3ff;
    border:1px solid rgba(255,255,255,.08);
    font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  .gwave-livebar .dot {
    width:10px; height:10px; border-radius:50%;
    background:#22c55e; /* default online */
    box-shadow:0 0 0 0 rgba(34,197,94,.7);
    animation: pulse 1.6s infinite;
  }
  .gwave-livebar.offline .dot { background:#ef4444; box-shadow:0 0 0 0 rgba(239,68,68,.6); }
  .gwave-livebar.stale   .dot { background:#f59e0b; box-shadow:0 0 0 0 rgba(245,158,11,.6); }

  @keyframes pulse {
    0%   { box-shadow:0 0 0 0 rgba(34,197,94,.7) }
    70%  { box-shadow:0 0 0 10px rgba(34,197,94,0) }
    100% { box-shadow:0 0 0 0 rgba(34,197,94,0) }
  }
  .gwave-livebar.offline @keyframes pulse { /* same timing; color driven by class */ }
  .gwave-livebar .label { letter-spacing:.02em; }
  .gwave-livebar .time  { opacity:.85 }
</style>

<div id="gwave-livebar" class="gwave-livebar" role="status" aria-live="polite">
  <span class="dot" aria-hidden="true"></span>
  <span class="label">LIVE</span>
  <span class="time">â€” Updated: <span id="gwave-updated">loadingâ€¦</span></span>
</div>

<script>
(function(){
  const tz = 'Australia/Sydney';
  const livebar = document.getElementById('gwave-livebar');
  const upEl    = document.getElementById('gwave-updated');

  // Insert right under the first H1 if possible (keeps the DOM tidy)
  try {
    const h1 = document.querySelector('h1');
    if (h1 && livebar && livebar.parentElement !== h1.parentElement) {
      h1.insertAdjacentElement('afterend', livebar);
    }
  } catch {}

  const formatAU = (ts) => {
    const d = (typeof ts === 'number') ? new Date(ts*1000) : new Date(ts);
    if (isNaN(d.getTime())) return 'â€”';
    return d.toLocaleString('en-AU', {
      timeZone: tz, hour12: false,
      year:'numeric', month:'short', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
  };

  const ageClass = (updatedMs) => {
    if (!updatedMs) return 'offline';
    const age = Date.now() - updatedMs;
    if (age > 5 * 60 * 1000) return 'offline'; // >5m = offline
    if (age > 90 * 1000)     return 'stale';   // >90s = stale
    return 'online';
  };

  // Prefer GH Pages mirror (relative), then fall back to local API
  const REL = 'data/pool.json';
  const LOCAL = 'http://127.0.0.1:5199/pool.json';

  const fetchWithFallback = async () => {
    const tryOne = (url) => fetch(url + (url.includes('?')?'&':'?') + '_cb=' + Date.now(), {
      cache: 'no-store'
    }).then(r => r.ok ? r.json() : Promise.reject(new Error(r.status)));

    try {
      try {
        return await tryOne(REL);
      } catch {
        return await tryOne(LOCAL);
      }
    } catch (e) {
      return null;
    }
  };

  const update = async () => {
    const data = await fetchWithFallback();

    if (!data) {
      livebar.classList.remove('online','stale'); livebar.classList.add('offline');
      upEl.textContent = 'connection error';
      return;
    }

    // Common fields: prefer .updated, else .timestamp, else now
    const updated =
      (data.updated && (typeof data.updated === 'number' || typeof data.updated === 'string'))
        ? data.updated
        : (data.timestamp || Date.now());

    const updatedMs = (typeof updated === 'number' && updated < 2e12) ? updated*1000 : Number(updated);

    // Set label
    upEl.textContent = formatAU(updatedMs);

    // Status classes
    livebar.classList.remove('online','stale','offline');
    livebar.classList.add(ageClass(updatedMs));
  };

  update();
  setInterval(update, 30000); // 30s refresh
})();
</script>
<!-- /GWAVE LIVE PULSE MODULE -->
</body>
</html>
